<!DOCTYPE html>
<html lang="en" class="h-full">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Translator App</title>
		<script src="https://cdn.tailwindcss.com"></script>
	</head>

	<body class="bg-gray-900 text-white h-full flex flex-col antialiased">
		<header class="bg-gray-800 shadow-md p-4 flex justify-between items-center">
			<h1 class="text-2xl font-bold">Power Translator</h1>
			<div id="user-greeting" class="flex items-center gap-2">
				<span id="user-name" class="font-semibold"></span>
				<button
					id="logout-btn"
					class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md"
				>
					Log Out
				</button>
			</div>
		</header>

		<main id="translator-page" class="flex-grow p-4 md:p-8 flex flex-col gap-6">
			<div
				class="w-full max-w-5xl mx-auto bg-gray-800 rounded-xl shadow-lg p-6"
			>
				<div class="flex flex-col md:flex-row gap-4">
					<div class="flex-1">
						<h2 class="font-semibold mb-2">English</h2>
						<textarea
							id="source-text"
							class="w-full h-48 bg-gray-700 p-3 rounded-md"
							placeholder="Enter text..."
						></textarea>
					</div>

					<div class="flex-1">
						<div class="flex justify-between items-center mb-2">
							<h2 class="font-semibold">Target</h2>
							<select
								id="target-lang"
								class="bg-gray-700 border border-gray-600 rounded-md p-1.5 text-white"
							>
								<option value="NL">Dutch</option>
								<option value="BG">Bulgarian</option>
							</select>
						</div>
						<textarea
							id="target-text"
							readonly
							class="w-full h-48 bg-gray-700 p-3 rounded-md text-gray-300"
						></textarea>
					</div>
				</div>

				<div class="mt-4 flex justify-center">
					<button
						id="translate-btn"
						class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-md transition-colors disabled:bg-blue-800 disabled:cursor-not-allowed"
					>
						<span id="translate-btn-text">Translate</span>
					</button>
				</div>
			</div>

			<div class="w-full max-w-5xl mx-auto flex-grow flex flex-col">
				<h2 class="text-xl font-semibold mb-4">Translation History</h2>
				<div
					id="history-container"
					class="flex-grow bg-gray-800 rounded-xl shadow-lg p-6 overflow-y-auto"
				>
					<div id="history-placeholder" class="text-gray-400 text-center py-10">
						Loading history...
					</div>
				</div>
			</div>
		</main>

		<script src="app.js"></script>

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				// ------------------------------
				// CONFIGURATION
				// ------------------------------
				const HISTORY_URL =
					"https://8ac60j2lnf.execute-api.eu-north-1.amazonaws.com/prod/TranslationHistory";
				const TRANSLATE_URL =
					"https://8ac60j2lnf.execute-api.eu-north-1.amazonaws.com/prod/OllamaTranslationHandler";
				
				// âŒ REMOVED: SQS_URL is no longer needed here.

				// ------------------------------
				// Load user
				// ------------------------------
				let currentUser = sessionStorage.getItem("currentUser");
				if (!currentUser) {
					window.location.href = "login.html";
					return;
				}

				document.getElementById(
					"user-name"
				).textContent = `Welcome, ${currentUser}`;

				document.getElementById("logout-btn").onclick = () => {
					// Ensure handleLogout exists in app.js, otherwise just clear session
					if (typeof handleLogout === "function") {
						const redirect = handleLogout();
						window.location.href = redirect;
					} else {
						sessionStorage.clear();
						window.location.href = "login.html";
					}
				};

				// ------------------------------
				// Load Translation History
				// ------------------------------
				async function fetchHistory() {
					const token = sessionStorage.getItem("authToken");
                    if(!token) return;

					try {
						const res = await fetch(HISTORY_URL, {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								Authorization: `Bearer ${token}`,
							},
							body: JSON.stringify({
								user_id: currentUser,
							}),
						});

						const data = await res.json();
						const container = document.getElementById("history-container");
						
						// Use Secure Render function from app.js if available
						if (typeof renderHistory === "function") {
							renderHistory(data.history, container);
						} else {
                            console.warn("renderHistory function missing in app.js");
                        }
					} catch (e) {
						console.error("Failed to load history", e);
					}
				}

				fetchHistory();

				// ------------------------------
				// Translation Request (SECURE)
				// ------------------------------
				document.getElementById("translate-btn").onclick = async () => {
					const textInput = document.getElementById("source-text");
					const langInput = document.getElementById("target-lang");
                    const outputInput = document.getElementById("target-text");
                    const btn = document.getElementById("translate-btn");
                    const btnText = document.getElementById("translate-btn-text");

					const text = textInput.value.trim();
					const lang = langInput.value;

					if (!text) return alert("Please enter text to translate.");

					const token = sessionStorage.getItem("authToken");
					if (!token) {
						alert("You are not logged in!");
						window.location.href = "login.html";
						return;
					}

                    // 1. UI Loading State
                    btn.disabled = true;
                    btnText.textContent = "Translating...";
                    outputInput.value = "Processing...";

					try {
						// 2. Single Secure Request
                        // The backend will handle the SQS logging now!
						const res = await fetch(TRANSLATE_URL, {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								Authorization: `Bearer ${token}`,
							},
							body: JSON.stringify({
								text,
								target_lang: lang,
                                // Note: user_id is extracted from token on backend
							}),
						});

						const data = await res.json();

						if (!res.ok) {
                            throw new Error(data.error || "Translation failed");
						}

                        // 3. Success
						outputInput.value = data.translation;

						// 4. Update history (Small delay to allow SQS -> DB to process)
                        setTimeout(() => fetchHistory(), 1500);

					} catch (err) {
						alert("An error occurred: " + err.message);
                        outputInput.value = ""; // Clear on error
					} finally {
                        // 5. Reset Button
                        btn.disabled = false;
                        btnText.textContent = "Translate";
                    }
				};
			});
		</script>
	</body>
</html>
